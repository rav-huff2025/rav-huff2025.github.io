import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";

const images = [
  "img/01_–≠–Ω–Ω–∏–ú—É—Ä.png",
  "img/02_–î–∂–∞—Ä–µ–¥–ö—Ä–∏–Ω.png",
  "img/03_–ê–ª–∏—Å–∞–ò–Ω–¥–∏–≥–æ.png",
  "img/04_–°–µ—Ä–∞—Ñ–∏–Ω–∞–õ–µ–π–Ω.png",
  "img/05_–õ–∏–≤–∞–£–Ω—Å–µ—Ç.png",
  "img/06_–ê–ª—å–±–æ—Ä–µ–∫–ú–æ—Ä—Ç–∏–º–µ—Ä.png"
];

function shuffle(array) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

const GamePage = () => {
  const [cards, setCards] = useState([]);
  const [flipped, setFlipped] = useState([]);
  const [matched, setMatched] = useState([]);
  const [moves, setMoves] = useState(0);
  const [startTime, setStartTime] = useState(null);
  const [elapsed, setElapsed] = useState(0);
  const [gameOver, setGameOver] = useState(false);

  useEffect(() => {
    let interval;
    if (startTime && !gameOver) {
      interval = setInterval(() => {
        setElapsed(Math.floor((Date.now() - startTime) / 1000));
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [startTime, gameOver]);

  useEffect(() => {
    if (matched.length === cards.length && cards.length > 0) {
      setGameOver(true);
    }
  }, [matched]);

  const startGame = () => {
    const selected = shuffle(images).slice(0, 6);
    const doubled = shuffle([...selected, ...selected]);
    const prepared = doubled.map((src, index) => ({ id: index, src }));
    setCards(prepared);
    setFlipped([]);
    setMatched([]);
    setMoves(0);
    setElapsed(0);
    setStartTime(Date.now());
    setGameOver(false);
  };

  const handleClick = (index) => {
    if (flipped.length === 2 || flipped.includes(index) || matched.includes(index)) return;
    const newFlipped = [...flipped, index];
    setFlipped(newFlipped);

    if (newFlipped.length === 2) {
      setMoves(moves + 1);
      const [first, second] = newFlipped;
      if (cards[first].src === cards[second].src) {
        setMatched([...matched, first, second]);
        setFlipped([]);
      } else {
        setTimeout(() => setFlipped([]), 800);
      }
    }
  };

  return (
    <div className="flex flex-col items-center p-6 min-h-screen bg-[#F6F2E6] text-[#4D3B2F] font-[\'Cormorant Unicase\']">
      <header className="bg-[#E8D9B6] p-4 w-full shadow text-center">
        <h1 className="text-4xl mb-2">–ü—É—Ñ—Ñ–µ–Ω–¥—É–π—Å–∫–∞—è –∏–≥—Ä–∞</h1>
        <p className="text-lg font-[\'Yanone Kaffeesatz\']">–ù–∞–π–¥–∏ –≤—Å–µ –ø–∞—Ä—ã –º–∞—Ä–æ–∫!</p>
      </header>

      <div className="my-6 flex gap-4">
        <Button onClick={startGame} className="bg-[#E8D9B6] text-[#4D3B2F] border border-[#4D3B2F] hover:bg-[#d8c9a6]">{cards.length > 0 ? "–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞" : "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"}</Button>
        <div className="text-lg">–•–æ–¥—ã: {moves}</div>
        <div className="text-lg">–í—Ä–µ–º—è: {elapsed} —Å–µ–∫</div>
      </div>

      <div className="grid grid-cols-6 gap-3 max-w-6xl">
        {cards.map((card, index) => {
          const isFlipped = flipped.includes(index) || matched.includes(index);
          return (
            <div
              key={card.id}
              className="relative aspect-[3/4] cursor-pointer group"
              onClick={() => handleClick(index)}
            >
              <div className={`absolute inset-0 transition-transform duration-500 ${isFlipped ? "rotate-y-180" : ""}`}
                   style={{ transformStyle: 'preserve-3d' }}>
                <img src={card.src} className="w-full h-full object-cover rounded shadow-lg backface-hidden" />
                <div className="absolute inset-0 bg-[#E8D9B6] rounded shadow-inner flex items-center justify-center backface-hidden rotate-y-180">
                  <span className="text-4xl">üúõ</span>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {gameOver && (
        <div className="mt-6 text-2xl text-green-700 font-bold animate-pulse">–í—ã –Ω–∞—à–ª–∏ –≤—Å–µ –ø–∞—Ä—ã! üéâ</div>
      )}

      <footer className="mt-auto w-full text-center p-4 bg-[#E8D9B6] text-[#4D3B2F] font-[\'Cormorant Unicase\']">
        ¬© –ü–æ–¥–∞—Ä–æ–∫ –∫–æ –î–Ω—é –ü—É—Ñ—Ñ–µ–Ω–¥—É—è 2025. –° –ª—é–±–æ–≤—å—é –æ—Ç –ö–æ–≥—Ç–µ–≤—Ä–∞–Ω–∞
      </footer>
    </div>
  );
};

export default GamePage;
